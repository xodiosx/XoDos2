name: Build Wine Staging ARM64 WoW64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BUILD_DIR: ${{ github.workspace }}/wine-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout Wine
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          git clone --depth 1 https://gitlab.winehq.org/wine/wine.git wine
          cd wine
          git submodule update --init --recursive

      - name: Checkout Wine Staging
        run: |
          cd $BUILD_DIR
          git clone --depth 1 https://github.com/wine-staging/wine-staging.git wine-staging
          cd wine-staging
          git submodule update --init --recursive

      - name: Apply Wine Staging patches
        run: |
          cd $BUILD_DIR/wine-staging
          python3 ./staging/patchinstall.py DESTDIR="$BUILD_DIR/wine" --all

      - name: Install build dependencies
        run: |
          # Add architectures for cross-compilation
          sudo dpkg --add-architecture i386
          
          # Update sources.list to include ports for ARM
          echo "deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=amd64,i386] http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          
          # Add ARM64 and ARMHF repositories (ports)
          echo "deb [arch=arm64,armhf] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm.list
          echo "deb [arch=arm64,armhf] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm.list
          echo "deb [arch=arm64,armhf] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm.list
          echo "deb [arch=arm64,armhf] http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm.list
          
          sudo apt-get update
          
          # Install basic build tools
          sudo apt-get install -y \
            build-essential \
            git \
            tar \
            xz-utils \
            cmake \
            ninja-build \
            flex \
            bison \
            gettext \
            python3 \
            python3-mako \
            python3-distutils \
            pkg-config \
            llvm \
            nasm \
            gcc-multilib \
            g++-multilib \
            mingw-w64 \
            meson \
            autoconf \
            automake \
            libtool \
            wget \
            software-properties-common
          
          # Add toolchain repository for better cross-compilation support
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          
          # Install cross-compilation toolchain
          sudo apt-get install -y \
            gcc-11-aarch64-linux-gnu \
            g++-11-aarch64-linux-gnu \
            gcc-11-arm-linux-gnueabihf \
            g++-11-arm-linux-gnueabihf \
            binutils-aarch64-linux-gnu \
            binutils-arm-linux-gnueabihf \
            libc6-dev-arm64-cross \
            libc6-dev-armhf-cross \
            crossbuild-essential-arm64 \
            crossbuild-essential-armhf
          
          # Install essential development libraries (native for host tools)
          sudo apt-get install -y \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxfixes-dev \
            libasound2-dev \
            libpulse-dev \
            libsdl2-dev \
            libvulkan-dev \
            libudev-dev \
            libcups2-dev \
            libgnutls28-dev \
            libxml2-dev \
            libpng-dev \
            libjpeg-dev

      - name: Build Wine tools for host system
        run: |
          cd $BUILD_DIR/wine
          
          # Create build directory for host tools
          mkdir -p build-tools
          cd build-tools
          
          # Configure and build tools for the host (x86_64)
          ../configure --enable-win64
          
          # Build only the tools (not the full Wine)
          make -j$(nproc) __tooldeps__

      - name: Download and extract ARM libraries
        run: |
          # Download sysroot for ARM64
          mkdir -p $BUILD_DIR/sysroot/arm64
          mkdir -p $BUILD_DIR/sysroot/armhf
          
          # Download essential ARM64 libraries
          cd $BUILD_DIR/sysroot/arm64
          wget http://ports.ubuntu.com/pool/main/a/alsa-lib/libasound2-dev_1.2.6.1-1ubuntu1_arm64.deb || true
          wget http://ports.ubuntu.com/pool/main/libx/libx11/libx11-dev_1.7.5-1_arm64.deb || true
          wget http://ports.ubuntu.com/pool/main/f/freetype/libfreetype6-dev_2.11.1+dfsg-1ubuntu0.2_arm64.deb || true
          
          # Download essential ARMHF libraries
          cd $BUILD_DIR/sysroot/armhf
          wget http://ports.ubuntu.com/pool/main/a/alsa-lib/libasound2-dev_1.2.6.1-1ubuntu1_armhf.deb || true
          wget http://ports.ubuntu.com/pool/main/libx/libx11/libx11-dev_1.7.5-1_armhf.deb || true
          wget http://ports.ubuntu.com/pool/main/f/freetype/libfreetype6-dev_2.11.1+dfsg-1ubuntu0.2_armhf.deb || true

      - name: Create sysroot for cross-compilation
        run: |
          # Create sysroot directories
          sudo mkdir -p /usr/aarch64-linux-gnu
          sudo mkdir -p /usr/arm-linux-gnueabihf
          
          # Copy basic libraries
          sudo cp -r /usr/aarch64-linux-gnu/lib/* /usr/aarch64-linux-gnu/ || true
          sudo cp -r /usr/arm-linux-gnueabihf/lib/* /usr/arm-linux-gnueabihf/ || true

      - name: Build 64-bit Wine (ARM64) with minimal dependencies
        run: |
          cd $BUILD_DIR/wine
          
          # Create build directory for 64-bit
          mkdir -p build64
          cd build64
          
          # Configure for ARM64 with minimal dependencies
          # Skip X and other problematic dependencies for now
          ../configure \
            --host=aarch64-linux-gnu \
            --enable-win64 \
            --prefix=/usr/local/wine-arm64 \
            --disable-tests \
            --without-x \
            --without-freetype \
            --without-alsa \
            --without-pulse \
            --without-cups \
            --with-wine-tools=../build-tools
          
          # Build 64-bit Wine
          make -j$(nproc) 2>&1 | tee build64.log || (echo "64-bit build failed"; tail -100 build64.log; exit 1)

      - name: Build 32-bit Wine (ARM) with WoW64 support
        run: |
          cd $BUILD_DIR/wine
          
          # Create build directory for 32-bit with WoW64
          mkdir -p build32
          cd build32
          
          # Configure 32-bit Wine with WoW64 support (minimal)
          ../configure \
            --host=arm-linux-gnueabihf \
            --with-wine64=../build64 \
            --prefix=/usr/local/wine-arm64 \
            --disable-tests \
            --without-x \
            --without-freetype \
            --without-alsa \
            --without-pulse \
            --without-cups \
            --with-wine-tools=../build-tools
          
          # Build 32-bit Wine with WoW64
          make -j$(nproc) 2>&1 | tee build32.log || (echo "32-bit build failed"; tail -100 build32.log; exit 1)

      - name: Install Wine WoW64
        run: |
          # Create installation directory
          mkdir -p $BUILD_DIR/wine-install/usr/local
          
          # Install 64-bit components
          cd $BUILD_DIR/wine/build64
          make install DESTDIR=$BUILD_DIR/wine-install 2>&1 | tee install64.log || true
          
          # Install 32-bit components
          cd $BUILD_DIR/wine/build32
          make install DESTDIR=$BUILD_DIR/wine-install 2>&1 | tee install32.log || true

      - name: Package Wine
        run: |
          cd $BUILD_DIR
          # Create a tarball of the installation
          tar -czf wine-arm64-wow64-minimal.tar.gz -C wine-install/usr/local .
          
          # Create build logs archive
          zip -r wine-build-logs.zip \
            wine/build64/build64.log \
            wine/build32/build32.log \
            wine/build64/config.log \
            wine/build32/config.log \
            install64.log \
            install32.log

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wine-staging-arm64-wow64
          path: |
            $BUILD_DIR/wine-arm64-wow64-minimal.tar.gz
            $BUILD_DIR/wine-build-logs.zip