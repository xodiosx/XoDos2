name: Build Wine WOW64 (Staging)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y \
          gcc-mingw-w64-x86-64 \
          gcc-mingw-w64-i686 \
          g++-mingw-w64-x86-64 \
          g++-mingw-w64-i686 \
          mingw-w64-tools \
          llvm \
          cmake \
          ninja-build \
          flex \
          bison \
          gettext \
          libasound2-dev \
          libpulse-dev \
          libglib2.0-dev \
          libx11-dev \
          libxext-dev \
          libxrender-dev \
          libxrandr-dev \
          libxi-dev \
          libfreetype-dev \
          libfontconfig-dev \
          libudev-dev \
          libsdl2-dev \
          libvulkan-dev \
          libunwind-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libfaudio-dev:i386 \
          libfaudio-dev \
          libudev-dev \
          libdbus-1-dev \
          python3 \
          python3-distutils \
          git \
          tar \
          xz-utils

    - name: Download Wine Staging
      run: |
        git clone https://github.com/wine-mirror/wine.git --branch master --depth=1
        git clone https://github.com/wine-staging/wine-staging.git

    - name: Apply Staging patches
      run: |
        cd wine-staging
        ./patchinstall.sh DESTDIR=../wine --all

    # -----------------------------
    # Build 64-bit Wine first
    # -----------------------------
    - name: Build Wine64
      run: |
        mkdir wine64-build
        cd wine64-build
        ../wine/configure --enable-win64
        make -j$(nproc)

    # -----------------------------
    # Build 32-bit Wine
    # -----------------------------
    - name: Build Wine32
      run: |
        mkdir wine32-build
        cd wine32-build
        ../wine/configure --with-wine64=../wine64-build
        make -j$(nproc)

    # -----------------------------
    # Install both into prefix
    # -----------------------------
    - name: Install Wine WOW64
      run: |
        mkdir -p AppDir
        cd wine64-build
        make install DESTDIR=$(pwd)/../AppDir
        cd ../wine32-build
        make install DESTDIR=$(pwd)/../AppDir

    # -----------------------------
    # Package for release
    # -----------------------------
    - name: Pack artifacts
      run: |
        cd AppDir
        tar -cJf ../wine-wow64.tar.xz .

    # -----------------------------
    # Upload Artifacts (v4)
    # -----------------------------
    - name: Upload wine-wow64.tar.xz
      uses: actions/upload-artifact@v4
      with:
        name: wine-wow64
        path: wine-wow64.tar.xz